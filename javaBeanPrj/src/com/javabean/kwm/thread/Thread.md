# 多线程
## 1、相关概念
### 1.1 程序、进程与线程
* **程序（program）**：为完成特定任务，用某种语言编写的`一组指令的集合`。即指`一段静态的代码`，静态对象。
* **进程（process）**：程序的一次执行过程，或是正在内存中运行的应用程序。如：运行中的QQ，运行总的网易音乐播放器。
   * 每个进程都有一个独立的内存空间，系统运行一个程序既是一个进程从创建、运行到小王的过程。（生命周期）
   * 程序是静态的，进程是动态的。
   * 进程作为`操作系统调度和分配资源的最小单元`（亦是系统运行程序的基本单元），系统在运行时会为每个进程分配不同的内存区域。
   * 现代的操作系统，大都是支持多进程的，支持同时运行多个程序。比如：我们可以一边使用编辑器，一遍使用听歌软件，同时还可以操作dos窗口等软件。
* **线程（thread）**：进程可以进一步细化为线程，是程序内部的`一条执行路径`。一个进程中至少有一个线程。
  - 一个进程同一时间若`并行`执行多个线程，就是支持多线程。
  <img src="images/image-20220331233204504.png" alt="image-20220331233204504" style="zoom:67%;" />
  - 线程作为`CPU调度和执行的最小单位`。
  - 一个进程中的多个线程共享相同的内存单元，它们从同一个堆中分配兑现个，可以访问相同的变量和对象。这就使得线程间通信更简便、高效。 但多个线程操作共享的系统资源
  可能就会带来`安全的隐患`。
  - 下图中的，红框的蓝色区域为线程独享，黄色区域为线程共享。
  <img src="images/image-20220514175737426.png" alt="image-20220514175737426" style="zoom:80%;" />
  >注意：
  >
  > 不同的进程之间是不同享内存的。
  > 
  > 进程之间的数据交换和通信的成本很高。
### 1.2查看进程和线程
我们可以在电脑底部任务栏，右键----->打开任务管理器，可以查看当前任务的进程。

1、每个应用程序的运行都是一个进程。
<img src="images/进程概念.png" style="zoom:80%;" />
2、一个应用的多次运行，就是多个进程。
<img src="images/1563267431480.png" alt="1563267431480" style="zoom:80%;" />
3、一个进程中可以包含多个线程。
> 举例
> 
> 1、聊天工具可以开发多个聊天窗口。
> 
> 2、杀毒软件可以边杀毒，边清理垃圾。
### 1.3 线程调度
- **分时调度**
  所有线程`轮流使用`CPU的使用权，并且平均分配每个线程占用CPU的时间。
- **抢占式调度**
  让`优先级高`的线程以`较大的概率`获取优先使用CPU权。如果线程优先级相同，那么就会随机选择一个（线程随机性），
  java使用的为抢占式调度。
![抢占式调度](images/抢占式调度.bmp)
### 1.4多线程的优点
**背景：** 以单核CPU为例，只使用单个线程先后完成多个任务（调用多个方法），肯定比用多个线程来完成用的时间更短，为何仍需要多线程呢？

**多线程程序的优点：**

1、提高应用程序的响应。对图形化界面更有意义，可增加用户体验。

2、提高计算机系统CPU的利用率。

3、改善程序结构。将既长又复杂的进程氛围多个线程，独立运行，利于理解和修改。

### 1.5 补充概念
#### 1.5.1 单核CPU和多核CPU
单核CPU，在一个时间单元内，只能执行一个线程的任务。例如，可以把CPU看成是医院的医生诊室，在一定时间内只能给一个病人诊断治疗。所以单核CPU就是，代码经过前面一系列的
前导操作（类似于医院挂号，比如有多个窗口挂号），然后到CPU处执行时发现，就只有一个CPU（对应一个医生），大家只能排队执行。

这时想要提升系统性能，只有两个办法，要么提升CPU性能（让医生看病快点），要么多加几个CPU（多安排几个医生），即为多核的CPU。

`问题，多核的效率是单核的倍数吗？`譬如4核A53的CPU，性能是单核A53的4倍吗？理论上是，但是实际上不可能，至少有两方面的损耗。

- `一个是多个核心的其他公用资源限制`。譬如，4核CPU对应的内存、cache、寄存器并没有同步扩充4倍。这就好像医院一样，1个医生换4个医生，但是做B超检查的还是一台机器，
性能瓶颈就是从医生转到B超检查了。
- `另一个是多核CPU之间的协调管理损耗`。譬如多个核心同时运行两个相关的任务，需要考虑任务同步，这也需要消耗额外性能。好比公司工作，一个人的时候只会少不用开会浪费
时间，自己跟自己商量就行了。两个人就要开会同步工作，协调分配，所以工作效率绝对不可能达到2倍。

#### 1.5.2 并行与并发

* **并行（parallel）**：指两个或多个事件在`同一时刻`发生（同时发生）。指在同一时刻内，有`多条指令`在`多个CPU`上`同时`执行。比如：多个人同事做不同的事。
 
  ![image-20220401000804242](images/image-20220401000804242.png)

  <img src="images/image-20220513181758585.png" alt="image-20220513181758585" style="zoom: 50%;" />

* **并发（concurrency）**：指两个或多个事件在`同一个时间段内`发生。即在一段时间内，有`多条指令`在`单个CPU`上`快速轮换、交替`执行，使得在宏观上具有多个进程
通知执行的效果。

  ![image-20220401000515678](images/image-20220401000515678.png)

  <img src="images/image-20220513181815978.png" alt="image-20220513181815978" style="zoom:50%;" />

在操作系统中，启动多个程序，`并发`值的是在在一段时间内宏观上有多个程序同时运行，这在单核CPU系统中，每一时刻只能有一个程序执行，即微观上这些程序是分时的交替运行，
只不过是给人的感觉是同时进行，那是因为分时交替运行的时间是非常短的。

而在多核CPU系统中，则这些可以`并发`执行的程序便可以被分配到多个CPU上，实现多任务并行执行，即利用每个处理器来处理一个可以并发执行的程序，这样多个程序便可以同时执
行。目前电脑市场上说的多核CPU，便是多核处理器，核越多，`并行`处理的程序越多，能大大的提高电脑运行的效率。

